name: ðŸš€ Deploy LimpiavenTura

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ðŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ðŸ—ï¸ Build Application
      run: npm run build -- --configuration=production
    
    - name: ðŸ”‘ Setup SSH Keys
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ðŸ“¤ Deploy with SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e
          echo "ðŸš€ Iniciando despliegue..."
          
          # Variables
          DEPLOY_PATH="${{ secrets.SERVER_PATH }}"
          
          cd "$DEPLOY_PATH"
          
          # 1. Backup actual
          if [ -d "dist" ]; then
            backup_dir="backup-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$backup_dir"
            cp -r dist "$backup_dir/"
            echo "âœ… Backup creado: $backup_dir"
          fi
          
          # 2. Limpiar dist actual
          rm -rf dist
          
          echo "ðŸ“¦ Preparando directorio..."
          mkdir -p dist
          
          # El script continÃºa en el servidor...
