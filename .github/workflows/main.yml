name: üöÄ Deploy LimpiavenTura

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v3
    
    - name: üü¢ Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - run: npm ci && npm run build
    
    - name: üîë Setup SSH Key PROPERLY
      run: |
        mkdir -p ~/.ssh
        # Crear clave en formato PEM expl√≠cito
        cat > ~/.ssh/deploy_key << 'EOF'
${{ secrets.SSH_PRIVATE_KEY }}
EOF
        chmod 600 ~/.ssh/deploy_key
        
        # Verificar formato
        echo "üîç Verificando clave..."
        if file ~/.ssh/deploy_key | grep -q "PEM"; then
          echo "‚úÖ Formato PEM correcto"
        elif file ~/.ssh/deploy_key | grep -q "OpenSSH"; then
          echo "‚úÖ Formato OpenSSH correcto"
        else
          echo "‚ùå Formato desconocido"
          file ~/.ssh/deploy_key
          exit 1
        fi
        
        # Agregar host
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: üì§ Deploy with SCP
      run: |
        scp -r -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          dist/ruta-verde/browser/* \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/dist/
    
    - name: ‚öôÔ∏è Configure
      run: |
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          sudo chown -R www-data:www-data ${{ secrets.SERVER_PATH }}/dist
          sudo chmod -R 755 ${{ secrets.SERVER_PATH }}/dist
          sudo systemctl restart apache2
          echo '‚úÖ Deployed to http://${{ secrets.DOMAIN }}'
        "
