name: ğŸš€ Deploy LimpiavenTura

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'  # CAMBIADO de 18 a 20
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build Application
      run: npm run build -- --configuration=production
    
    - name: ğŸ”‘ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ“¤ Deploy to Server
      run: |
        # Variables
        SERVER="${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        PATH_ON_SERVER="${{ secrets.SERVER_PATH }}"
        
        echo "ğŸš€ Desplegando a: $SERVER"
        
        # Crear archivo temporal
        tar -czf deploy.tar.gz -C dist .
        
        # Subir al servidor
        scp -i ~/.ssh/id_ed25519 deploy.tar.gz $SERVER:/tmp/deploy.tar.gz
        
        # Ejecutar en servidor
        ssh -i ~/.ssh/id_ed25519 $SERVER "
          set -e
          
          echo 'ğŸ“‚ Preparando despliegue...'
          cd '$PATH_ON_SERVER'
          
          # 1. Backup actual
          if [ -d 'dist' ]; then
            backup_dir=\"backup-\$(date +%Y%m%d-%H%M%S)\"
            mkdir -p \"\$backup_dir\"
            cp -r dist \"\$backup_dir/\"
            echo 'âœ… Backup creado'
          fi
          
          # 2. Extraer nuevos archivos
          echo 'ğŸ“¦ Extrayendo nueva versiÃ³n...'
          tar -xzf /tmp/deploy.tar.gz -C .
          
          # 3. Instalar dependencias en servidor (opcional)
          echo 'ğŸ“¦ Actualizando dependencias...'
          npm ci --only=production
          
          # 4. Permisos
          echo 'ğŸ” Configurando permisos...'
          chmod -R 755 dist
          sudo chown -R www-data:www-data dist
          
          # 5. Reiniciar Apache
          echo 'ğŸŒ Reiniciando Apache...'
          sudo systemctl restart apache2
          
          # 6. Limpiar
          rm -f /tmp/deploy.tar.gz
          
          echo 'âœ… Â¡Despliegue completado!'
          echo 'ğŸŒ Disponible en: http://${{ secrets.DOMAIN }}'
        "
        
        # Limpiar local
        rm -f deploy.tar.gz
        
    - name: âœ… Verify Deployment
      run: |
        echo "Esperando que Apache inicie..."
        sleep 8
        if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.DOMAIN }} | grep -q "200"; then
          echo "âœ… Sitio funcionando correctamente"
        else
          echo "âš ï¸  Sitio podrÃ­a estar iniciando..."
        fi
