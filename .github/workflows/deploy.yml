name: üöÄ Deploy LimpiavenTura

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: üü¢ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: üì¶ Install Dependencies
      run: npm ci
    
    - name: üèóÔ∏è Build Application
      run: npm run build
    
    - name: üîë Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: üì§ Sync files
      run: |
        # Sincronizar archivos - YA con permisos correctos
        rsync -avz \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --chown=www-data:www-data \
          --chmod=755 \
          dist/ruta-verde/browser/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/dist/
    
    - name: ‚öôÔ∏è Configure Apache (sin sudo)
      run: |
        # En lugar de sudo, usamos otros m√©todos
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          set -e
          
          echo 'üîÑ Reiniciando Apache...'
          
          # M√©todo 1: Usar systemctl sin sudo (si est√° permitido)
          systemctl --user restart apache2 2>/dev/null || \
          
          # M√©todo 2: Usar apache2ctl directamente
          apache2ctl restart 2>/dev/null || \
          
          # M√©todo 3: Enviar se√±al HUP al proceso Apache
          echo '‚ö†Ô∏è  No se pudo reiniciar Apache normalmente'
          echo 'üí° Intento alternativo...'
          APACHE_PID=\$(cat /var/run/apache2/apache2.pid 2>/dev/null || echo '')
          if [ -n \"\$APACHE_PID\" ]; then
            kill -HUP \$APACHE_PID
            echo '‚úÖ Apache recargado (se√±al HUP)'
          else
            echo '‚ö†Ô∏è  No se encontr√≥ PID de Apache'
            echo 'üí° La aplicaci√≥n se despleg√≥ pero Apache necesita reinicio manual'
          fi
          
          echo '‚úÖ Archivos desplegados'
          echo 'üåê Disponible en: http://${{ secrets.DOMAIN }}'
        "
