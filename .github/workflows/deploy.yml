name: ğŸš€ Deploy LimpiavenTura

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build Application
      run: npm run build -- --configuration=production
    
    - name: ğŸ“¦ Create deployment package
      run: |
        # Crear paquete para subir
        cd dist/ruta-verde/browser
        tar -czf ../../../deploy.tar.gz ./*
        cd ../../../
        echo "ğŸ“¦ Package created: deploy.tar.gz"
        ls -lh deploy.tar.gz
    
    - name: ğŸ”‘ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ“¤ Upload package to server
      run: |
        scp -i ~/.ssh/id_ed25519 \
          deploy.tar.gz \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/deploy.tar.gz
        
        echo "âœ… Package uploaded to server"
    
    - name: ğŸš€ Execute deployment on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e
          echo "ğŸš€ Iniciando despliegue..."
          
          DEPLOY_PATH="${{ secrets.SERVER_PATH }}"
          
          cd "$DEPLOY_PATH"
          
          # 1. Backup actual
          if [ -d "dist" ]; then
            backup_dir="backup-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$backup_dir"
            cp -r dist "$backup_dir/"
            echo "âœ… Backup creado: $backup_dir"
          fi
          
          # 2. Limpiar directorio actual
          rm -rf dist
          mkdir -p dist
          
          # 3. Extraer nuevo paquete
          echo "ğŸ“¦ Extrayendo nueva versiÃ³n..."
          tar -xzf /tmp/deploy.tar.gz -C dist/
          
          # 4. Configurar permisos
          echo "ğŸ” Configurando permisos..."
          sudo chown -R www-data:www-data dist
          sudo chmod -R 755 dist
          
          # 5. Limpiar archivo temporal
          rm -f /tmp/deploy.tar.gz
          
          # 6. Reiniciar Apache
          echo "ğŸŒ Reiniciando Apache..."
          sudo systemctl restart apache2
          
          echo "âœ… Â¡Despliegue completado!"
          echo "ğŸŒ Disponible en: http://${{ secrets.DOMAIN }}"
    
    - name: âœ… Verify deployment
      run: |
        echo "â³ Esperando que Apache reinicie..."
        sleep 8
        echo "ğŸ” Verificando sitio..."
        
        # Intentar acceder al sitio
        if curl -f -s -o /dev/null -w "HTTP: %{http_code}\n" "http://${{ secrets.DOMAIN }}"; then
          echo "âœ… Â¡Sitio funcionando correctamente!"
        else
          echo "âš ï¸  El sitio podrÃ­a estar iniciando..."
          echo "ğŸ’¡ Revisa los logs en el servidor: sudo tail -f /var/log/apache2/error.log"
        fi
