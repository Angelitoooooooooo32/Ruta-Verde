name: üöÄ Deploy LimpiavenTura

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v3
    
    - name: üü¢ Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - run: npm ci && npm run build
    
    - name: üîë Setup RSA SSH Key
      run: |
        mkdir -p ~/.ssh
        
        # Crear archivo con formato RSA CORRECTO
        cat > ~/.ssh/deploy_key << 'EOF'
${{ secrets.SSH_PRIVATE_KEY }}
EOF
        
        chmod 600 ~/.ssh/deploy_key
        
        # Verificar que es RSA
        echo "üîç Verificando clave RSA..."
        if head -1 ~/.ssh/deploy_key | grep -q "BEGIN RSA PRIVATE KEY"; then
          echo "‚úÖ Formato RSA correcto"
        else
          echo "‚ùå No es formato RSA"
          exit 1
        fi
        
        # Agregar host
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # Probar conexi√≥n
        echo "üîó Probando conexi√≥n..."
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          "echo '‚úÖ SSH funciona con clave RSA'"
    
    - name: üì§ Deploy files
      run: |
        scp -r -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          dist/ruta-verde/browser/* \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/dist/
    
    - name: ‚öôÔ∏è Configure server
      run: |
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          sudo chown -R www-data:www-data ${{ secrets.SERVER_PATH }}/dist
          sudo chmod -R 755 ${{ secrets.SERVER_PATH }}/dist
          sudo systemctl restart apache2
          echo '‚úÖ ¬°Despliegue exitoso!'
          echo 'üåê http://${{ secrets.DOMAIN }}'
        "
    
    - name: ‚úÖ Verify
      run: |
        sleep 5
        echo "üîç Verificando sitio..."
        
        if curl -s -f -o /dev/null -w "%{http_code}\n" "http://${{ secrets.DOMAIN }}" | grep -q "200\|304"; then
          echo "‚úÖ Sitio funcionando"
        else
          echo "‚ö†Ô∏è  Verifica manualmente: http://${{ secrets.DOMAIN }}"
        fi
